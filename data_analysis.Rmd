---
title: "Data Analysis"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
```


```{r}
library(readxl)
library(tidyverse)
library(leaflet)
```


## Data Preparation

*   Subset to ug/m3 and the three given chemicals only  

```{r}
project_id_list = read_csv("data/brooklyn_cvcp_list.csv")
alpha = read_csv("data/cleandata/alpha.csv")
mixed = read_csv("data/cleandata/mixed.csv")

alpha_sub = alpha %>% 
  select(street_address, sample_id, parameter, ug_m3_results) %>% 
  filter(parameter %in% c("Benzene", "Toluene", "Ethylbenzene", "o-Xylene", "p/m-Xylene", "Trichloroethene", "Tetrachloroethene"))

alpha_sub = left_join(alpha_sub, select(project_id_list, project_id, street_address = name), 
                      by = "street_address") %>%
  mutate(project_id = ifelse(street_address == "75 Dupont Street", "17CVCP035K",
                             ifelse(street_address == "161 Harrison Avenue", "19CVCP022K",
                                    ifelse(street_address == "174 Kings Highway", "19CVCP021K",
                                           ifelse(street_address == "777 Glenmore Avenue", "19CVCP001K",
ifelse(street_address == "820 Glenmore Avenue", "18CVCP009K", project_id)))))) %>%
  select(project_id, street_address, sample_id, everything())

mixed_sub = mixed %>% 
  select(street_address, sample_id, parameter, ug_m3_results) %>% 
  filter(parameter %in% c("Benzene", "Toluene", "Ethylbenzene", "o-Xylene", "p/m-Xylene", "Trichloroethene", "Tetrachloroethene"))

mixed_sub = left_join(mixed_sub, select(project_id_list, project_id, street_address = name), 
                      by = "street_address") %>% 
  select(project_id, street_address, sample_id, everything())

mixed_sub = mixed_sub %>% 
  slice(-(25:30))

bind_wide = bind_rows(alpha_sub, mixed_sub) %>% 
  pivot_wider(
    names_from = parameter,
    values_from = ug_m3_results
  ) %>% 
select(project_id, street_address, sample_id, Benzene, Toluene, Ethylbenzene, `o-Xylene`, `p/m-Xylene`, Trichloroethene, Tetrachloroethene)
```

*   Fill in missing values for `project_no` and `address` from the summary data  

```{r}
summary_data = read_excel("data/data_from_M/Summary of SV data for Capstone_236 sites.xlsx") %>% 
  janitor::clean_names() %>% 
  fill(c("project_no", "address"))
```

*   Merge `project_id` with lat/long

```{r, eval = FALSE}
geocoding = read_excel("Geocoding ALL.xlsx") %>% 
  janitor::clean_names() %>% 
  select(-name, -note) %>% 
  select(name = address, everything())

geo_info = left_join(project_id_list,
                     geocoding,
                     by = "name")

# write_csv(geo_info, file = "data/geo_info.csv")
```


```{r}
geo_info = read_csv("data/geo_info.csv")

geo_info %>% 
  leaflet() %>% 
  addTiles() %>%
  setView(-73.97968, 40.703312, zoom = 12) %>%
  addProviderTiles("CartoDB.Positron") %>% 
  addCircleMarkers(~ longitude, ~ latitude, radius = 1)
```

